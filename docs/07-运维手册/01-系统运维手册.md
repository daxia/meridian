# Meridian 系统运维手册

本文档详细描述 Meridian AI 新闻聚合系统的部署、配置、监控与日常运维操作。

## 1. 系统概览

Meridian 是一个基于 Monorepo 架构的现代化全栈应用，主要由以下组件构成：

| 组件 | 目录 | 技术栈 | 部署目标 |
| :--- | :--- | :--- | :--- |
| **Frontend** (前端) | `apps/frontend` | Nuxt 3, Vue 3 | Cloudflare Pages / Vercel / Netlify |
| **Backend** (后端) | `apps/backend` | Cloudflare Workers, Hono, Durable Objects | Cloudflare Workers |
| **ML Service** (AI服务) | `services/meridian-ml-service` | Python, FastAPI, Sentence-Transformers | Docker 容器 / VPS (Systemd) |
| **Database** (数据库) | `packages/database` | PostgreSQL + pgvector | Supabase / Neon / 自建 PostgreSQL |
| **Logger** (日志) | `packages/logger` | TypeScript | (作为库被其他服务引用) |

---

## 2. 环境准备

### 2.1 本地开发环境

在开始运维工作前，请确保本地安装了以下工具：

- **Node.js**: v20.x 或更高版本
- **pnpm**: v9.x (`npm install -g pnpm`)
- **Python**: v3.11 或更高版本 (用于 ML Service)
- **Docker Desktop**: 用于本地运行 PostgreSQL 和 ML Service 容器
- **Wrangler CLI**: Cloudflare 开发工具 (`pnpm install -g wrangler`)

### 2.2 生产环境要求

- **Cloudflare 账号**: 需开通 Workers 和 R2 存储权限。
- **PostgreSQL 数据库**: 支持 `pgvector` 插件的 PostgreSQL 实例（推荐 Supabase 或 Neon）。
- **Linux 服务器 (可选)**: 如果不使用 Serverless 部署 ML Service，需要一台安装了 Docker 的 Linux 服务器。

---

## 3. 配置管理

### 3.1 环境变量 (.env)

项目根目录及各子应用均需配置 `.env` 文件。请参考 `.env.example` 创建。

**核心环境变量：**

```ini
# Database Connection (用于 Backend 和 Database Migration)
DATABASE_URL="postgresql://user:password@host:5432/meridian?sslmode=require"

# ML Service URL (Backend 调用 ML Service)
ML_SERVICE_URL="http://localhost:8000" # 本地
# ML_SERVICE_URL="https://ml-api.yourdomain.com" # 生产

# Authentication (Backend)
JWT_SECRET="your-super-secret-key"
ADMIN_PASSWORD="your-admin-password"

# Cloudflare (用于部署)
CLOUDFLARE_ACCOUNT_ID="your-account-id"
CLOUDFLARE_API_TOKEN="your-api-token"
```

### 3.2 Wrangler 配置 (Backend)

后端服务的配置位于 `apps/backend/wrangler.toml`。
- **Durable Objects**: 需确保 `[[durable_objects]]` 绑定正确。
- **KV Namespaces**: 需确保 `[[kv_namespaces]]` 绑定正确。
- **Smart Placement**: 建议开启 `smart_placement = true` 以优化延迟。

---

## 4. 部署指南

### 4.1 数据库部署 (PostgreSQL)

1.  **准备数据库**: 创建一个新的 PostgreSQL 实例。
2.  **启用插件**: 执行 SQL `CREATE EXTENSION IF NOT EXISTS vector;`。
3.  **运行迁移**:
    ```bash
    # 在项目根目录执行
    pnpm --filter @meridian/database migrate
    ```
    此命令会将 `packages/database/drizzle` 中的 Schema 同步到数据库。

### 4.2 后端部署 (Cloudflare Workers)

1.  **登录 Cloudflare**:
    ```bash
    npx wrangler login
    ```
2.  **发布 Backend**:
    ```bash
    cd apps/backend
    pnpm run deploy
    ```
    发布成功后，Wrangler 会输出 Worker 的 URL (例如 `https://meridian-backend.your-subdomain.workers.dev`)。

### 4.3 前端部署 (Cloudflare Pages)

1.  **构建前端**:
    ```bash
    cd apps/frontend
    pnpm run build
    ```
2.  **发布**:
    - **方法 A (推荐)**: 连接 GitHub 仓库到 Cloudflare Pages，设置构建命令为 `pnpm run build`，输出目录为 `.output/public`。
    - **方法 B (手动)**: 使用 Wrangler 发布 `.output/public` 目录。

### 4.4 ML Service 部署 (Docker)

ML Service 是一个 Python 服务，建议通过 Docker 部署。

1.  **构建镜像**:
    ```bash
    cd services/meridian-ml-service
    docker build -t meridian-ml-service .
    ```
2.  **运行容器**:
    ```bash
    docker run -d \
      -p 8000:8000 \
      --name meridian-ml \
      -e DATABASE_URL="postgresql://..." \
      meridian-ml-service
    ```
    确保该服务可以通过公网访问（如果 Backend 部署在 Cloudflare），或者与 Backend 在同一私有网络中（如果使用 Cloudflare Tunnel）。

---

## 5. 监控与日志

### 5.1 日志查看

本项目集成了 `@meridian/logger`，支持结构化 JSON 日志。

- **Backend Logs**:
  - 在 Cloudflare Dashboard -> Workers & Pages -> meridian-backend -> Logs 中查看实时日志。
  - 使用 `wrangler tail` 命令查看实时流日志：
    ```bash
    cd apps/backend
    npx wrangler tail
    ```

- **Frontend Logs**:
  - 浏览器控制台 (Console)。
  - 服务端渲染 (SSR) 日志可在部署平台的控制台查看。

- **ML Service Logs**:
  - `docker logs -f meridian-ml`

### 5.2 监控指标

- **Cloudflare Analytics**: 监控 Backend 的请求数、CPU 时间、错误率。
- **Database Metrics**: 监控 PostgreSQL 的连接数、查询延迟、存储使用量。

---

## 6. 常见运维操作

### 6.1 数据库迁移 (Schema Update)

当修改了 `packages/database/src/schema.ts` 后：

1.  **生成迁移文件**:
    ```bash
    pnpm --filter @meridian/database generate
    ```
2.  **应用迁移**:
    ```bash
    pnpm --filter @meridian/database migrate
    ```

### 6.2 手动触发 RSS 抓取

如果在管理后台无法触发，可以直接调用 Backend API：

```bash
curl -X POST https://your-backend-url/admin/source/{sourceId}/trigger \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### 6.3 备份策略

- **数据库**: 配置每日自动备份（大多数云数据库提供商支持）。
- **代码**: 定期推送到 Git 仓库。
- **配置**: 安全存储 `.env` 文件副本（不要提交到 Git）。

---

## 7. 故障排查 (Troubleshooting)

| 问题现象 | 可能原因 | 解决方案 |
| :--- | :--- | :--- |
| **Backend 500 Error** | 数据库连接失败 / 代码异常 | 检查 `DATABASE_URL` 是否正确；查看 Cloudflare Logs 获取详细堆栈信息。 |
| **Frontend 无法连接 Backend** | CORS 问题 / URL 配置错误 | 检查 Frontend 的 `NUXT_PUBLIC_API_BASE` 环境变量；检查 Backend 的 `cors` 中间件配置。 |
| **ML Service 超时** | 向量模型加载慢 / 资源不足 | 增加 ML Service 的内存限制；使用 GPU 加速（如可能）。 |
| **Wrangler EPERM Error** | Windows 权限问题 | 使用 `start_all.js` 启动，或手动设置 `XDG_CONFIG_HOME` 到本地目录。 |

