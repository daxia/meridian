# EXP-SYS-日志功能增强与中文化实战

## 1. 背景与问题

随着系统组件的增多，原有的日志体系暴露出以下问题：
1.  **日志文件无限增长**：`start_all.js` 启动的服务日志（如 `backend.log`）会不断追加，导致文件过大，难以管理。
2.  **语言障碍**：系统默认日志均为英文，对于中文团队来说，在快速定位问题时不够直观。
3.  **运行状态盲区**：RSS 源的抓取状态（如下次抓取时间）缺乏主动监控，只能被动等待日志报错。

## 2. 解决方案

本次优化涵盖了系统启动脚本 (`start_all.js`) 和后端服务 (`apps/backend`) 两个层面。

### 2.1 日志轮转 (Log Rotation)

修改 `start_all.js`，在每次启动服务时，根据当前时间生成唯一的日志文件名。

**核心代码 (`start_all.js`)**:

```javascript
const now = new Date();
const timestamp = now.getFullYear() + '-' +
  String(now.getMonth() + 1).padStart(2, '0') + '-' +
  String(now.getDate()).padStart(2, '0') + '-' +
  String(now.getHours()).padStart(2, '0') + '-' +
  String(now.getMinutes()).padStart(2, '0') + '-' +
  String(now.getSeconds()).padStart(2, '0');
  
const logFile = `${baseLogName}-${timestamp}.log`;
```

**效果**:
- `logs/backend-2026-02-14-10-30-00.log`
- `logs/frontend-2026-02-14-10-30-00.log`

### 2.2 日志中文化 (Localization)

将系统级的提示信息和关键业务日志汉化。

**启动脚本**:
- `Starting...` -> `正在启动...`
- `Services started` -> `所有服务已启动`

**后端监控**:
- 使用中文模板字符串记录源状态。

### 2.3 源状态主动监控 (Active Monitoring)

利用 Cloudflare Workers 的 Cron Triggers 功能，实现每分钟自检。

**实现逻辑 (`apps/backend/src/index.ts`)**:

```typescript
async scheduled(event: ScheduledEvent, env: Env, ctx: ExecutionContext) {
  // ... 连接数据库 ...
  const sources = await db.select().from($data_sources);
  
  for (const source of sources) {
    // 计算下次抓取时间
    const diffSec = Math.round((nextCheck - now) / 1000);
    
    logger.info(`[SourceMonitor] 源 ${source.name} (ID: ${source.id}) 距离下次抓取还有 ${diffSec} 秒`, {
       // ... 结构化字段
    });
  }
}
```

## 3. 验证结果

1.  **文件检查**: 每次重启 `node start_all.js`，`logs/` 目录下均生成新的带时间戳文件。
2.  **内容检查**: 终端输出和日志文件内容均为中文提示，无乱码。
3.  **监控检查**: 后端日志中每分钟出现 `[SourceMonitor]` 开头的中文状态报告。

## 4. 经验总结

- **系统级日志**：在 `start_all.js` 这种编排脚本中处理日志轮转是最简单的方案，无需引入复杂的 `winston` 或 `log4js` 配置。
- **本地化**：对于内部工具，日志中文化能显著降低运维认知负荷。
- **Workers Cron**：利用 Cron Trigger 做轻量级监控非常高效，且不占用 HTTP 请求资源。
