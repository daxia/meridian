# Git中文提交信息乱码问题解决方案 - 20260126

## 问题描述

在使用 Git 命令行直接提交中文提交信息时，会出现乱码问题。

### 问题现象

**错误示例：**
```bash
git commit -m "fix: 添加robot_move_to_ready_pos任务配置"
```

**查看提交历史时显示乱码：**
```
commit edda4b2fdbc72d7b699960c1363822501ee3adb0
Author: 王胜中 <632618392@qq.com>
Date:   Mon Jan 26 20:57:03 2026 +0800

    fix: 娣诲姞robot_move_to_ready_pos浠诲姟閰嶇疆锛屼慨澶嶆墍鏈塪ish瀹屾垚鍚庢満鍣ㄤ汉鏃犳硶绉诲姩鍒皉eady浣嶇疆鐨勯棶棰?
```

中文字符全部变成了乱码，无法正常阅读。

## 根本原因

### 编码问题分析

1. **PowerShell 默认编码**：Windows PowerShell 默认使用 GBK 编码
2. **Git 期望编码**：Git 期望接收 UTF-8 编码的提交信息
3. **编码不匹配**：当 PowerShell 传递 GBK 编码的中文给 Git 时，Git 按 UTF-8 解析导致乱码

### 技术细节

- PowerShell 将中文字符按 GBK 编码后传给 Git
- Git 将这些字节按 UTF-8 编码存储
- 查看时 Git 按 UTF-8 解码，但实际内容是 GBK 编码的字节，导致乱码

## 正确解决方案

### 方法：使用 UTF-8 文件 + `git commit -F` 命令

这是最可靠和推荐的方法。

#### 步骤1：创建 UTF-8 编码的提交信息文件

使用代码编辑工具（如 VSCode、Write 工具）创建 UTF-8 格式的文本文件：

**文件名：** `commit_msg.txt`

**内容示例：**
```
fix: 添加robot_move_to_ready_pos任务配置，修复所有dish完成后机器人无法移动到ready位置的问题

修改内容：
1. 在task_list.json中添加robot_10任务定义，支持move_to_ready_pos命令
2. 添加开发记录文档，记录问题分析和解决方案

问题描述：
- 所有dish完成拍照后，机器人没有移动到ready位置
- 系统无法正常暂停，422-430行代码一直循环执行

解决方案：
- 在task_list.json中添加robot_10任务
- 规则引擎rule_list.txt中已有正确的触发条件配置
- 暂停逻辑dev_system_manager.py第924-927行已存在
```

#### 步骤2：使用 -F 参数提交

```bash
# 暂存修改
git add .

# 使用文件方式提交
git commit -F commit_msg.txt
```

#### 步骤3：清理临时文件

```bash
# 提交成功后删除临时文件
Remove-Item commit_msg.txt
```

### 完整示例代码

**使用 Write 工具创建文件（推荐在自动化脚本中使用）：**

```python
# 使用 Write 工具创建 UTF-8 文件
Write(
    path="commit_msg.txt",
    contents="""fix: 添加功能说明

详细的提交信息内容...
"""
)

# 执行 git 命令
Shell("git add .")
Shell("git commit -F commit_msg.txt")
Shell("Remove-Item commit_msg.txt")
```

## 修正已有的乱码提交

如果已经产生了乱码提交，可以使用 `git commit --amend` 修正：

### 步骤1：创建正确的提交信息文件

```bash
# 创建 UTF-8 格式的 commit_msg.txt 文件
# 内容为正确的提交信息
```

### 步骤2：修正最后一次提交

```bash
git commit --amend -F commit_msg.txt
```

### 步骤3：强制推送（如果已推送到远程）

```bash
# 警告：这会修改提交历史，谨慎使用
git push --force
```

### 注意事项

1. **只能修正最后一次提交**：`--amend` 只能修改最近的一次提交
2. **修改历史的影响**：如果已推送到远程，需要 `--force` 推送，会影响其他协作者
3. **团队协作**：在团队项目中使用 `--force` 前务必与团队沟通

## 错误方法（不推荐）

### ❌ 方法1：直接在命令行中使用中文

```bash
# 错误！会产生乱码
git commit -m "fix: 添加功能"
```

**问题：** PowerShell 的编码问题会导致乱码

### ❌ 方法2：使用 Bash 的 HEREDOC 语法

```bash
# 在 PowerShell 中不支持
git commit -m "$(cat <<'EOF'
fix: 添加功能
EOF
)"
```

**问题：** PowerShell 不支持 Bash 的 HEREDOC 语法

### ❌ 方法3：修改 PowerShell 编码（效果不稳定）

```powershell
# 不推荐！效果不稳定
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
chcp 65001
```

**问题：** 
- 只在当前会话有效
- 可能影响其他命令的输出
- 不同 PowerShell 版本表现不一致

## 最佳实践

### 项目规范（AGENTS.md）

在项目的 `AGENTS.md` 文件中明确规定：

```markdown
### 中文提交信息流程

**中文提交必须用Write工具创建UTF-8文件，然后用 `git commit -F 文件名`提交**

详细说明参见：`docs/经验教训/Git中文提交信息乱码解决方案-20260126.md`
```

### 自动化工具封装

**推荐创建辅助函数：**

```python
def git_commit_chinese(message: str):
    """
    使用正确的方式提交中文信息
    
    Args:
        message: 中文提交信息
    """
    # 1. 创建 UTF-8 文件
    Write(path="commit_msg.txt", contents=message)
    
    # 2. 提交
    Shell("git commit -F commit_msg.txt")
    
    # 3. 清理
    Shell("Remove-Item commit_msg.txt")
```

### Git 配置建议

虽然不能完全解决问题，但以下配置可以改善 Git 的中文支持：

```bash
# 设置 Git 的日志输出编码
git config --global i18n.logOutputEncoding utf-8

# 设置提交信息编码
git config --global i18n.commitEncoding utf-8

# 在 Windows 上支持长路径
git config --global core.longpaths true

# 设置引用路径的方式
git config --global core.quotepath false
```

## 验证方法

### 检查提交信息是否正确

```bash
# 查看最近的提交
git log -1

# 查看详细信息
git log -1 --pretty=full

# 查看原始字节（调试用）
git cat-file commit HEAD
```

### 正确的显示示例

```
commit 70427a1fd7c2a6dade8a766aa02758eac72af6b7
Author: 王胜中 <632618392@qq.com>
Date:   Mon Jan 26 20:57:03 2026 +0800

    fix: 添加robot_move_to_ready_pos任务配置，修复所有dish完成后机器人无法移动到ready位置的问题
    
    修改内容：
    1. 在task_list.json中添加robot_10任务定义
```

如果中文显示正常，说明提交信息编码正确。

## 相关问题

### Q1: 为什么其他人的中文提交没问题？

**A:** 可能的原因：
1. 他们使用了 Git GUI 工具（如 TortoiseGit、SourceTree），这些工具会自动处理编码
2. 他们使用 Git Bash 而不是 PowerShell
3. 他们使用了正确的 `-F` 文件方式

### Q2: Linux/Mac 上也有这个问题吗？

**A:** 通常没有。Linux 和 Mac 的终端默认就是 UTF-8 编码，与 Git 匹配。这是 Windows 特有的问题。

### Q3: 可以用 Git GUI 工具代替命令行吗？

**A:** 可以。GUI 工具通常会自动处理编码问题。但在自动化脚本和 CI/CD 流程中，命令行方式更适合，所以掌握命令行的正确方法很重要。

## 总结

### 核心要点

1. ✅ **推荐方法**：使用 UTF-8 文件 + `git commit -F` 命令
2. ❌ **避免方法**：直接在 PowerShell 命令行中使用中文
3. 🔧 **修正方法**：使用 `git commit --amend -F` 修正已有的乱码提交
4. 📝 **项目规范**：在 AGENTS.md 中明确规定提交流程

### 记住这个口诀

> **中文提交信息，先写文件再提交**
> 
> `Write file → git commit -F → Delete file`

### 实践建议

- 在项目中统一使用文件方式提交中文信息
- 将方法封装成辅助函数或脚本
- 在 CI/CD 流程中确保使用正确的方法
- 定期检查提交历史，发现乱码及时修正

## 参考资料

- Git 官方文档：https://git-scm.com/docs/git-commit
- PowerShell 编码问题：https://docs.microsoft.com/en-us/powershell/
- 项目规范：`AGENTS.md` 第64-68行

## 更新记录

- 2026-01-26：初次创建，记录Git中文提交信息乱码问题及解决方案
