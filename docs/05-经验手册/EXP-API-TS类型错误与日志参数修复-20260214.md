# 经验手册：TS 类型错误与 Logger 参数顺序修复

## 1. 问题描述

在后端开发过程中，TypeScript 编译器频繁报出以下错误：

```typescript
Argument of type 'Error' is not assignable to parameter of type 'Record<string, unknown>'.
  Index signature for type 'string' is missing in type 'Error'.
```

或者：

```typescript
对象字面量只能指定已知属性，并且“pathname”不在类型“Error”中。
```

这些错误主要出现在调用 `logger.error` 和 `logger.warn` 的地方。

## 2. 根因分析

经过排查，发现 `@meridian/logger` 库中 `error` 和 `warn` 方法的参数签名设计不一致，导致开发者在调用时容易混淆参数顺序。

### Logger 方法签名定义

**`logger.error`**:
```typescript
error(message: string, error?: Error, context?: Record<string, unknown>)
```
*   第 2 参数：`Error` 对象
*   第 3 参数：Context 对象

**`logger.warn`**:
```typescript
warn(message: string, context?: Record<string, unknown>, error?: Error)
```
*   第 2 参数：Context 对象
*   第 3 参数：`Error` 对象

### 错误模式

1.  **将 Error 传给 Context (针对 `error` 方法)**：
    ```typescript
    // 错误写法
    logger.error('Message', undefined, error); // 第3参数应该是 context，这里传了 error
    // 导致 TS 报错：Error 类型不能赋值给 Record<string, unknown>
    ```

2.  **将 Context 传给 Error (针对 `warn` 方法)**：
    ```typescript
    // 错误写法
    logger.warn('Message', undefined, { key: 'value' }); // 第3参数应该是 error，这里传了 context 对象
    // 导致 TS 报错：对象字面量不在类型 Error 中
    ```

3.  **将 Context 传给 Error (针对 `error` 方法)**：
    ```typescript
    // 错误写法 (来自 dataSourceIngestorDO.ts)
    queueLogger.error(
      'Failed to send batch to queue',
      { batch_index: ... }, // 错误：第2参数应该是 error
      queueError // 错误：第3参数应该是 context
    );
    // 导致 TS 报错：对象字面量只能指定已知属性，并且“batch_index”不在类型“Error”中。
    ```

## 3. 解决方案

### 修正参数顺序

必须严格遵守方法签名：

**对于 `logger.error`**:
```typescript
// 正确写法
logger.error('Message', error); // 只有 error
logger.error('Message', error, { key: 'value' }); // error + context
```

**对于 `logger.warn`**:
```typescript
// 正确写法
logger.warn('Message', { key: 'value' }); // 只有 context
logger.warn('Message', { key: 'value' }, error); // context + error
```

### 最佳实践

1.  **利用 IDE 提示**：在编写 `logger.` 调用时，注意观察 IDE 弹出的参数提示，确认当前方法的参数顺序。
2.  **统一风格**：建议在团队内部统一日志调用风格，尽量避免传递 `undefined` 作为占位符，而是使用重载或可选参数特性。

## 4. 相关代码变更

本次修复涉及以下文件：
- `apps/backend/src/durable_objects/dataSourceIngestorDO.ts`
- `apps/backend/src/workflows/processIngestedItem.workflow.ts`
- `apps/backend/src/routers/sources.router.ts`
- `apps/backend/src/lib/rateLimiter.ts`
- `apps/backend/src/routers/durableObjects.router.ts`

同时完成了相关日志信息的中文本地化。

## 5. Zod 版本不一致导致的类型实例化过深

### 问题描述
IDE 报错 `Type instantiation is excessively deep and possibly infinite`，通常指向使用 Zod Schema 的复杂类型推断处（如 `dataSourceIngestorDO.ts`）。

### 根因分析
Monorepo 中不同包使用了不同版本的 `zod`。
- `apps/backend`: `3.24.3`
- `packages/database`: `3.22.4`

当 Backend 引用 Database 导出的 Schema 时，由于 Zod 内部类型的微小差异，TypeScript 尝试进行复杂的兼容性推断，导致递归深度溢出。

### 解决方案
统一 Monorepo 中所有包的 `zod` 版本。
1.  检查所有 `package.json`。
2.  将 `packages/database/package.json` 中的 `zod` 版本升级到与 `apps/backend` 一致（如 `^3.24.3`）。
3.  运行 `pnpm install` 更新锁文件。

### 验证
运行 `npx tsc --noEmit` 确认相关错误消失。

## 6. TS6059: File is not under 'rootDir'

### 问题描述
运行 `tsc` 时报错 `File '.../packages/database/src/index.ts' is not under 'rootDir' ...`。

### 根因分析
`apps/backend/tsconfig.json` 中设置了 `"rootDir": "."` 或 `"rootDir": "./src"`，但代码引用了项目外部（`../../packages`）的源码文件。TypeScript 要求所有编译涉及的文件必须在 `rootDir` 之下。

### 解决方案
在 Monorepo 开发模式下（非 Project References），通常不需要显式指定 `rootDir`，让 TypeScript 自动推断最长公共路径。

**操作**：
从 `apps/backend/tsconfig.json` 中移除 `"rootDir"` 配置。
