# REQ-WEB-文章重处理与简报生成错误分析报告

**日期**: 2026-02-14
**状态**: 已修复
**作者**: Trae AI

---

## 1. 问题描述

用户在使用 Meridian 系统时遇到以下两个主要问题：

1.  **前端 SQL 错误**：前端日志频繁出现 `ERROR [cache] SWR handler error. syntax error at or near "desc"`，导致部分页面（特别是简报相关页面）无法正常加载或显示数据。
2.  **文章重处理无效**：在 Admin 界面点击“重处理文章”后，虽然 API 返回 200 OK，且后端日志显示 `ProcessArticles` 工作流已启动，但紧接着 `GenerateBrief` 工作流提示 `No articles found in the last 24 hours`，表明文章并未被实际重新处理。

## 2. 原因分析

### 2.1 前端 SQL 错误 (`syntax error at or near "desc"`)

*   **根本原因**：Drizzle ORM 字段引用错误。
*   **详细分析**：
    *   在 `apps/frontend/src/server/api/briefs/index.get.ts` 等文件中，代码尝试使用 `$reports.createdAt` 进行排序：`orderBy: desc($reports.createdAt)`。
    *   在 `packages/database/src/schema.ts` 中，`reports` 表的定义如下：
        ```typescript
        created_at: timestamp('created_at', { mode: 'date' }).defaultNow().notNull(),
        ```
    *   由于未配置全局驼峰映射（Camel Case Mapping），Drizzle 返回的表对象 `$reports` 使用与数据库列名一致的键名，即 `created_at`（Snake Case）。
    *   因此，`$reports.createdAt` 的值为 `undefined`。
    *   当调用 `desc(undefined)` 时，Drizzle 生成的 SQL 片段出现了语法错误（类似于 `ORDER BY DESC` 而缺少列名），导致 Postgres 抛出 `syntax error at or near "desc"`。

### 2.2 文章重处理无效

*   **根本原因**：`ProcessArticles` 工作流中的过滤器过于严格，拦截了重处理请求。
*   **详细分析**：
    *   `apps/backend/src/workflows/processIngestedItem.workflow.ts` 中存在以下查询逻辑：
        ```typescript
        .where(
          and(
            isNull($ingested_items.processed_at), // 仅处理未处理过的
            gte($ingested_items.published_at, last48Hours), // 仅处理最近48小时的
            isNull($ingested_items.fail_reason), // 仅处理无失败记录的
            inArray($ingested_items.id, ids) // 目标 ID
          )
        )
        ```
    *   当用户手动触发“重处理”时，目标文章通常不满足上述前三个条件（例如：文章已处理过但需要更新、文章曾处理失败、或文章发布于数天前）。
    *   这导致工作流虽然接收到了 ID 列表，但在数据库查询阶段过滤掉了所有文章，实际处理数量为 0。
    *   由于文章未被重新处理，其 `processed_at` 字段未更新。
    *   随后的 `GenerateBrief` 工作流查找最近 24 小时内处理过的文章 (`processed_at`)，自然找不到任何结果。

## 3. 解决方案

### 3.1 修复前端 SQL 错误

*   **文件**：
    *   `apps/frontend/src/server/api/briefs/index.get.ts`
    *   `apps/frontend/src/server/api/briefs/latest.get.ts`
    *   `apps/frontend/src/server/api/briefs/[slug]/index.get.ts`
    *   `apps/frontend/src/server/api/reports.get.ts`
*   **修改**：将所有 `$reports.createdAt` 替换为正确的 `$reports.created_at`。同时确保返回给前端的对象属性名与前端组件预期一致（如果前端预期 `createdAt`，则在 map 函数中进行转换）。

### 3.2 修复后端重处理逻辑

*   **文件**：`apps/backend/src/workflows/processIngestedItem.workflow.ts`
*   **修改**：简化 `where` 过滤条件。
*   **逻辑变更**：既然调用者（无论是自动抓取还是手动重处理）明确传递了 `ingested_item_ids`，工作流应信任该列表并强制处理这些文章，而不应再校验其状态（是否已处理、是否失败）或发布时间。
    ```typescript
    // 修改后
    .where(
      inArray($ingested_items.id, _event.payload.ingested_item_ids)
    )
    ```

## 4. 验证与后续

*   **验证步骤**：
    1.  重启后端服务。
    2.  在 Admin 界面选择一篇旧文章或失败的文章进行重处理。
    3.  检查后端日志，确认 `ProcessArticles` 输出了 `Fetched 1 articles`（或其他数量），并成功执行了内容抓取和 Embedding 生成。
    4.  检查前端 Briefs 页面，确认页面正常加载，无 500 错误。
*   **后续建议**：
    *   在前端 Admin 界面增加更直观的重处理反馈（如 Toast 提示）。
    *   考虑在数据库层或 ORM 层统一命名规范（如统一启用驼峰映射），以避免类似的大小写混淆错误。
