# 重处理文章 401 错误分析报告

**日期**: 2026-02-14
**状态**: 已修复
**作者**: AI Assistant

## 1. 问题描述

在 Admin 管理后台点击“重新处理文章”按钮时，请求失败，前端弹出错误提示：
`[POST] "/api/admin/articles/reprocess": 401 Server Error`

这意味着后端拒绝了该请求，原因是未授权（Unauthorized）。

## 2. 原因分析

经过对前后端代码的审查，发现问题的根源在于**鉴权令牌（Token）的混用**和**配置引用的错误**。

### 2.1 认证机制不匹配

*   **后端要求 (Worker)**:
    `apps/backend/src/routers/admin.router.ts` 中的 `/admin` 路由使用了 `hasValidAuthToken` 中间件。该中间件检查请求头 `Authorization` 是否等于 `Bearer ${env.API_TOKEN}`。这是一个预共享密钥（PSK），用于服务间通信或管理员访问。

*   **前端实现 (Nuxt Server API)**:
    在修复前的 `apps/frontend/src/server/api/admin/articles/reprocess.post.ts` 中，代码尝试从用户的 Cookie 中读取 `auth_token`：
    ```typescript
    const token = getCookie(event, 'auth_token');
    // ...
    Authorization: `Bearer ${token}`,
    ```
    这个 `auth_token` 是 Nuxt Auth Utils 生成的会话令牌，用于验证**浏览器用户是否登录了 Nuxt 应用**。它与后端 Worker 所要求的 `API_TOKEN` 完全不同。

*   **冲突**: 后端收到的是用户的会话 Cookie，而不是预期的 API Key，因此返回 401。

### 2.2 配置引用错误

前端代码中使用了 `config.public.backendUrl`，但在 `nuxt.config.ts` 中，后端 API 地址被定义为 `config.public.WORKER_API`。虽然在这个特定场景下可能因为本地环境配置巧合而未报错，但这在生产环境中会导致请求发往错误的地址。

## 3. 解决方案

我们需要在 Nuxt 的 Server API 层充当“代理”角色：
1.  **验证用户**: 确认发起请求的浏览器用户已登录 Admin 面板（使用 `requireUserSession`）。
2.  **验证后端**: 使用 Nuxt 配置中存储的 `worker.api_token` 向后端 Worker 发起请求。

### 代码变更

**文件**: `apps/frontend/src/server/api/admin/articles/reprocess.post.ts`

```typescript
import { defineEventHandler } from 'h3';

export default defineEventHandler(async (event) => {
  const config = useRuntimeConfig();
  
  // 1. 验证前端用户会话 (Nuxt Auth)
  await requireUserSession(event);

  try {
    // 2. 使用正确的 API 地址和 Worker API Token 发起请求
    const response = await $fetch(`${config.public.WORKER_API}/admin/articles/reprocess`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${config.worker.api_token}`, // 使用配置中的 API Token
      },
    });

    return response;
  } catch (error: any) {
    throw createError({
      statusCode: error.response?.status || 500,
      message: error.response?._data?.message || 'Failed to reprocess articles',
    });
  }
});
```

## 4. 结论

该问题是由于混淆了“用户会话 Token”和“服务间 API Token”导致的。修复后，Nuxt 服务器充当了可信客户端，使用正确的凭证与后端 Worker 通信，从而解决了 401 错误。
