---
title: 简报生成失败故障分析与修复报告
date: 2026-02-14
status: 已修复
author: Trae AI
---

# 简报生成失败故障分析与修复报告

## 1. 问题描述
用户反馈系统未生成“真实”的情报简报，数据库中仅存在一条名为“测试情报简报”的 Mock 记录。虽然系统显示有大量文章处于处理完成状态，但简报生成工作流似乎未能捕捉到这些内容。

## 2. 故障排查过程

### 2.1 初步诊断
编写并运行 `scripts/check_db_status.ts` 脚本，检查数据库状态：
- **报告表 (`$reports`)**：仅发现 1 条测试记录。
- **文章表 (`$ingested_items`)**：
    - `PROCESSED`: 235 篇
    - `NEW`: 706 篇
    - `FAILED_FETCH`: 3 篇

### 2.2 深入分析
进一步检查 `PROCESSED` 状态文章的时间戳字段 `processed_at`。
- **发现异常**：所有 235 篇 `PROCESSED` 文章的 `processed_at` 字段均为 `NULL`。
- **影响**：`GenerateBriefWorkflow` 工作流在查询待总结文章时，依赖 `processed_at` 字段进行时间窗口过滤（如 `processed_at > 24小时前`）。由于该字段为空，查询结果为空，导致工作流直接结束，未生成任何简报。

### 2.3 根因定位
- **直接原因**：数据库中已处理文章的 `processed_at` 字段数据缺失。
- **可能原因**：
    1. 早期版本的文章处理逻辑未正确写入该字段。
    2. 或是此前进行过手动数据订正或迁移，遗漏了该时间戳。
    3. （已排除）当前代码逻辑：经检查 `processIngestedItem.workflow.ts`，当前逻辑已包含 `processed_at: new Date()` 的写入操作，因此该问题应属于历史数据脏数据。

## 3. 修复方案

### 3.1 数据修复
编写 `scripts/fix_processed_dates.ts` 脚本，执行以下 SQL 逻辑：
```sql
UPDATE ingested_items
SET processed_at = COALESCE(ingested_at, NOW())
WHERE status = 'PROCESSED' AND processed_at IS NULL;
```
该操作将缺失的处理时间回填为文章的采集时间（`ingested_at`），如果采集时间也缺失，则回填为当前时间。

### 3.2 触发生成
编写 `scripts/trigger_brief.ts` 脚本：
1. 自动检测数据库中最新文章的处理时间。
2. 动态计算 `hoursLookback` 参数（回溯时间），确保覆盖到最新的文章。
3. 调用后端 API (`POST /admin/briefs/trigger`) 手动触发简报生成。

## 4. 执行结果
1. **数据修复**：成功修复 235 条记录的时间戳。
2. **触发生成**：检测到最新文章处理时间约为 13 小时前，自动设定回溯窗口为 38 小时，并成功触发工作流。
3. **验证**：后台工作流已启动，预计将在数分钟内生成包含真实文章的简报。

## 5. 后续建议
- **监控**：建议在 `processIngestedItem` 工作流中增加对 `processed_at` 写入的断言检查。
- **定期清理**：对于积压的 706 篇 `NEW` 状态文章，建议分批次触发处理，避免一次性消耗过多 Token。
