---
doc_type: prd
doc_id: PRD-API-核心服务需求
owner: backend
related_requirement:
  - 我的需求
created: 2026-02-14
updated: 2026-02-14
---
# 产品需求文档（PRD）：核心服务需求

**需求来源**：docs/01-我的需求/我的需求.md

本文档负责 **Backend API & Workflows** 相关的核心业务逻辑需求。

---

## 2. 变更记录

- **2026-02-14**:
  - **需求编号**: 20260214007
  - **内容**: 新增情报汇总自动化流程需求。
  - **目标**: 实现从文章抓取到生成日报的全链路自动化。

- **2026-02-14**:
  - **需求编号**: 20260214014
  - **内容**: 新增简报生成失败诊断与修复需求。
  - **目标**: 诊断并修复 GenerateBriefWorkflow 无法找到符合条件的文章的问题，恢复简报生成功能。

---

## 需求1：情报汇总自动化流程 (已完成)

**需求编号**: 20260214007

**DD编号**: DD-API-核心服务需求

### 1. 需求功能点

**1）定时触发汇总**:

- **描述**: 系统应具备定时任务（Cron），定期（例如每天 06:00, 18:00）触发情报汇总工作流。
- **验收标准**: 到达预定时间后，系统自动创建 `GenerateBriefWorkflow` 实例，并在日志中记录。

**2）汇总生成工作流 (Workflow)**:

- **描述**: `GenerateBriefWorkflow` 需按顺序执行：
  1. **Fetch**: 从数据库查询过去 N 小时内未处理的文章。
  2. **Cluster**: 调用 ML Service 对文章进行聚类。
  3. **Summarize**: 调用 LLM 对聚类结果进行总结。
  4. **Save**: 将生成的 Brief 存入 `reports` 表。
- **验收标准**: 工作流能成功跑通，数据库中生成新的 Report 记录。

### 2. 目标与约束

- **目标**: 消除人工介入，实现全自动化的日报生成。
- **约束**: Cloudflare Workers 的 CPU 时间限制；LLM API 的 Token 消耗控制。

### 3. 当前实现分析

目前系统仅完成了 RSS 抓取和单篇文章的向量化。缺少将分散文章“串”起来生成报告的逻辑。`start_all.js` 启动了 ML 服务，但后端尚未调用其聚类接口（接口可能也不存在）。

### 4. 需求审核疑问

（无）

### 5. 需求审核结论

**审核结果**: 批准
**审核日期**: 2026-02-14
**结论**: 核心功能缺失，必须补充。

---

## 需求2：简报生成失败诊断与修复 (待实现)

**需求编号**: 20260214014

**DD编号**: （待创建）

### 1. 需求功能点

**1）问题诊断**:

- **描述**: 系统需要提供诊断功能，查明为何 `GenerateBriefWorkflow` 无法找到符合条件的文章。
- **验收标准**:
  - 能够查看数据库中文章的状态分布（各状态数量）
  - 能够查看最近处理的文章列表及其关键信息
  - 能够验证 ML Service 可用性
- **实现要点**:
  - 新增 API 端点：`GET /api/admin/diagnostic/articles-status`
    - 返回各状态文章统计（NEW, PROCESSED, FAILED_FETCH, FAILED_RENDER, FAILED_EMBEDDING 等）
    - 返回最近 10 条 PROCESSED 文章（包含 id, title, processed_at, has_embedding）
    - 返回最近 10 条 FAILED 文章（包含 id, title, status, fail_reason）
  - 新增 API 端点：`GET /api/admin/diagnostic/ml-health`
    - 检查 ML Service HTTP 连接性
    - （可选）测试 embedding 生成接口
  - Admin 界面新增诊断页面或按钮，展示上述信息

**2）问题修复**:

- **描述**: 根据诊断结果，修复导致简报生成失败的根本原因。
- **验收标准**:
  - `GenerateBriefWorkflow` 能够成功查询到过去24小时内处理完成的文章
  - 能够完成聚类分析和简报生成
  - Admin 界面手动触发简报生成功能正常工作
- **实现要点**:
  - 根据诊断结果确定根因（如：RSS抓取失败、文章处理失败、embedding生成失败等）
  - 修复相应模块的 bug 或逻辑错误
  - 新增批量重新处理功能：
    - API 端点：`POST /api/admin/articles/reprocess-batch`
    - 参数：`{ status: string[], limit?: number }`
    - 功能：批量重新处理指定状态的文章（默认最多 100 条）
  - 改进错误处理和日志记录

### 2. 目标与约束

- **目标**: 恢复简报生成功能，确保每日情报汇总正常工作。
- **约束**:
  - 不破坏现有数据
  - 保持向后兼容
  - 遵循最小化改动原则

### 3. 当前实现分析

`GenerateBriefWorkflow` 的查询条件为：

```typescript
and(
  eq($ingested_items.status, 'PROCESSED'),
  isNotNull($ingested_items.embedding),
  gte($ingested_items.processed_at, since)  // since = 24小时前
)
```

可能的原因：

1. RSS 抓取失败，没有新文章入库
2. 文章处理工作流失败，状态停留在 `NEW`、`FAILED_*` 等
3. Embedding 生成失败（ML Service 不可用）
4. `processed_at` 字段未正确更新

### 4. 需求审核疑问

**问题1**: 是否需要保留诊断功能，还是仅在修复过程中使用？

- **推荐**: 保留诊断功能，作为 Admin 界面的调试工具。
- **优劣说明**:
  - 保留：方便后续问题排查，提升可维护性
  - 不保留：减少代码复杂度，但后续排查困难
    回答：保留

**问题2**: 如果发现大量文章处理失败，是否需要批量重新处理？

- **推荐**: 是的，提供批量重新处理功能。
- **优劣说明**:
  - 提供：快速恢复数据，提升用户体验
  - 不提供：需要手动逐个处理，效率低下
    提供

**问题3**: ML Service 不可用时的降级方案？

- **推荐**: 添加健康检查和告警，但不降级（简报生成依赖聚类）。
- **优劣说明**:
  - 不降级：保证简报质量，但可能导致功能不可用
  - 降级：提供基本功能，但聚类效果差
    不降级

### 5. 需求审核结论

**用户回答记录**：
- 问题1（保留诊断功能）：**保留**
- 问题2（批量重新处理）：**提供**
- 问题3（ML Service 降级）：**不降级**

**审核结果**: 批准 ✓
**审核日期**: 2026-02-14
**结论**: PRD 已批准，进入设计阶段。
