---
doc_type: prd
doc_id: PRD-SYS-日志功能需求
owner: system
related_requirement:
  - 20260214002
created: 2026-02-14
updated: 2026-02-14
---
# 产品需求文档（PRD）：日志功能需求

**需求来源**：docs/01-我的需求/我的需求.md

本文文档针对的功能模块：System (Infrastructure) / Logger Package

---

## 1. 引言

### 1.1 背景
Meridian 系统包含多个服务（Frontend, Backend, ML Service），日志分散在不同层级。为了便于运维排错与系统监控，需要统一的日志功能规范，涵盖日志的采集、格式化、存储与展示。当前的重点是解决本地开发环境下的日志可读性问题。

### 1.2 目标
定义系统级日志功能需求，确保日志清晰、统一且易于分析。初期阶段优先解决本地日志文件乱码（ANSI 码）问题，后续可扩展至日志分级、轮转等需求。

---

## 2. 变更记录

- **2026-02-14**:
  - **需求编号**: 20260214002
  - **内容**: 定义日志文件 ANSI 清理需求。
  - **目标**: 提升日志可读性。
- **2026-02-14**:
  - **需求编号**: 20260214003
  - **内容**: 定义日志文件轮转与源状态监控需求。
  - **目标**: 优化日志归档管理，增强系统可见性。
- **2026-02-14**:
  - **需求编号**: 20260214004
  - **内容**: 日志信息中文化。
  - **目标**: 提升中文开发者的调试效率。

---

## 需求1：日志文件 ANSI 颜色代码清理 (已完成)

**需求编号**: 20260214002

**DD编号**: DD-SYS-日志功能需求

### 1. 需求功能点

**1）日志输出流处理**:

- **描述**: 修改 `start_all.js` 中的子进程输出处理逻辑。
- **UI/UX 交互**: 无。
- **验收标准**:
    1.  运行 `node start_all.js` 后，终端输出依然有颜色。
    2.  查看 `logs/frontend.log`、`logs/backend.log` 等文件，内容为纯文本，无乱码或 `[xxm` 字符。

### 2.目标与约束

- **目标**: 清晰、可读的日志文件。
- **约束**: 不引入重量级日志库，仅在 `start_all.js` 层面处理。

### 3. 当前实现分析

当前直接将 `p.stdout` 和 `p.stderr` 的数据块写入文件流，导致 Buffer 中的 ANSI 码被原样写入。

### 4. 需求审核结论

**审核结果**: 批准

**审核日期**: 2026-02-14

**结论**: 同意实施。

---

## 需求4：日志归档与历史管理 (已完成)

**需求编号**: 20260214008

**DD编号**: DD-SYS-日志功能需求

### 1. 需求功能点

**1）启动时归档旧日志**:

- **描述**: 在 `start_all.js` 启动并创建新日志文件之前，自动检查 `logs/` 目录。
- **逻辑**:
    1. 检查 `logs/history/` 文件夹是否存在，不存在则创建。
    2. 扫描 `logs/` 根目录下的所有 `.log` 文件。
    3. 将这些文件移动至 `logs/history/` 目录中。
- **验收标准**:
    1. 在 `logs/` 目录下存在旧的 `.log` 文件时运行启动脚本。
    2. 启动后，`logs/` 根目录仅包含本次新生成的日志文件。
    3. 旧文件完整出现在 `logs/history/` 目录下。

### 2.目标与约束

- **目标**: 保持日志目录整洁，避免文件堆积，同时防止误删历史记录。
- **约束**: 仅在启动时执行一次，不影响运行时的日志写入。

### 3. 当前实现分析

- **现状**: 每次启动生成新文件（如 `backend-2026...log`），导致 `logs/` 根目录文件列表越来越长，难以快速找到最新日志。

### 4. 需求审核结论

**审核结果**: 批准

**审核日期**: 2026-02-14

**结论**: 同意实施。

---

## 需求2：日志文件轮转与监控增强 (已完成)

**需求编号**: 20260214003

**DD编号**: DD-SYS-日志功能需求

### 1. 需求功能点

**1）日志文件轮转**:

- **描述**: 修改 `start_all.js`，每次启动时生成带时间戳的新日志文件（如 `backend-YYYY-MM-DD-HH-mm-ss.log`），避免追加写入导致文件过大或混淆。
- **验收标准**: 重启 `start_all.js` 后，`logs/` 目录下应出现新的带时间戳的日志文件。

**2）源状态监控日志**:

- **描述**: 在后端 Worker 中实现每分钟定时任务，遍历活跃数据源，计算并打印距离下次抓取的倒计时。
- **验收标准**: Backend 日志中每分钟出现类似 `[SourceMonitor] Source X (ID: 1) next fetch in 120s` 的记录。

### 2.目标与约束

- **目标**: 更好的归档管理与运行状态可见性。
- **约束**: 监控日志应轻量级，不显著增加 DB 负载。

### 3. 当前实现分析

- **日志文件**: 目前使用 `fs.createWriteStream(..., { flags: 'a' })` 追加写入固定文件名。
- **监控**: 目前只有 DO 内部的 Alarm 机制，缺乏全局视图。

### 4. 需求审核疑问

#### 问题 1：监控日志频率
> **Agent 提问**: 每分钟遍历所有源可能会在源数量较多（如 >1000）时产生性能压力。是否可以接受仅打印即将抓取（如 <5分钟）的源？
>
> **需求方回答**：暂按每分钟全量打印，源数量目前较少。

### 5. 需求审核结论

**审核结果**: 批准

**审核日期**: 2026-02-14

**结论**: 同意实施。

---

## 需求3：日志记录中文化 (已完成)

**需求编号**: 20260214004

**DD编号**: DD-SYS-日志功能需求

### 1. 需求功能点

**1）启动脚本日志汉化**:

- **描述**: `start_all.js` 中所有 `console.log` 输出的提示信息需改为中文。
- **示例**: "Starting backend..." -> "正在启动后端服务..."。
- **验收标准**: 运行 `node start_all.js`，终端输出的流程提示为中文。

**2）源监控日志汉化**:

- **描述**: 后端定时任务输出的 `[SourceMonitor]` 日志需使用中文。
- **示例**: "[SourceMonitor] Source X next fetch in 120s" -> "[SourceMonitor] 源 X (ID: 1) 距离下次抓取还有 120 秒"。
- **验收标准**: Backend 日志中的监控信息为中文。

### 2.目标与约束

- **目标**: 降低语言障碍，提升开发体验。
- **约束**: 仅针对系统级日志和新增的监控日志，不强制要求第三方库日志汉化。

### 3. 当前实现分析

- **start_all.js**: 硬编码的英文 Log 字符串。
- **Backend Monitor**: 尚未实现，直接在实现时使用中文即可。

### 4. 需求审核结论

**审核结果**: 批准

**审核日期**: 2026-02-14

**结论**: 同意实施。
