本文档为 docs / gui-docs 的最高约束规范，
所有 Agent 与人工操作均必须遵守。

# docs-agents 最小可行规范 v1

>> 适用范围：
>>
>> * 根目录 `docs/` (唯一文档目录)
>> * 作为 Claude / ChatGPT / Cursor / Copilot 的长期文档代理规范
>>
>> **重要警告**：禁止在 `gui/docs/` 或 `ui/docs/` 等子目录存放任何文档。所有开发文档必须统一归口至根目录 `docs/`。
>>

---

## 1. 设计目标（Design Goals）

1. **Design-First 强约束**
   * 未通过设计文档审核，不允许进入代码修改阶段
2. **Agent 可执行**
   * 文档状态、关系、权限必须机器可解析
3. **单一事实源（SSOT）**
   * 每一类关键信息只有一个权威来源
4. **可追溯**
   * 任一实现、修复、重构都能反向追溯到需求或设计

---

## 2. 目录结构（不改变你现有结构）

各目录下**文档文件名必须符合 2.1 节命名规范**，走设计流程时新建文档一律按规范命名。

docs/
├── 01-我的需求/
├── 02-产品需求文档PRD/
├── 03-架构设计/
├── 04-设计文档/
├── 05-经验手册/
├── 06-开发记录/
├── 07-运维手册/
├── 08-提示词/
├── 09-重构记录/
├── 10-分析报告/
├── 11-接口管理/        # 接口/API 说明、契约、变更
├── _policies/          # Agent 强约束规则（新增）
├── _views/             # Agent 自动生成的当前视图（新增）
├── image/
└── 设备电路图/

### 2.1 文档命名规范【强制，走设计流程时必须遵守】

**所有在 docs/ 下新建或补充的文档，必须严格按下列格式命名。命名不符合规范或存放在非 docs/ 目录的文档视为未纳入流程，不得作为审核或实现依据。**

#### 格式规则

| 目录               | 文件名格式                                                  | 说明                                                                                                                                                                                                                                                                                                | 示例                                                                                 |
| ------------------ | ----------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| 01-我的需求        | **我的需求.md**（原则上唯一）                         | 单一需求文档为 我的需求.md，用户在其中按条追加；**严禁删除或覆盖旧需求**（即使已完成或废弃）；每条需求须带**唯一编号**（见 2.1.1）、**状态**（待实现、进行中、已完成、废弃、未来实现）、可选**关联 PRD**、可选**关联 DD**；主题与日期在文档内每条标题与日期中体现。需求审核、疑问与结论在 02-PRD 内完成，不在 01 中填写。 | 我的需求.md、REQ-GUI-xxx-20260210.md（历史保留）                                     |
| 02-产品需求文档PRD | **PRD-[范围]-主题**.md                                | 前缀 PRD-，范围标识 (-WEB-/-API-等)，后接主题。**模块化 PRD 允许增量更新，见 10.1 节。文件名不带日期后缀。**                                                                                                                                                                                  | PRD-WEB-Admin页面需求.md、PRD-SYS-日志功能需求.md                                    |
| 03-架构设计        | **ARCH-[范围]-主题**.md                               | 前缀 ARCH-；主题中含 -WEB-/-API-/-ML-/-DB-/-SYS- 范围标识。**文件名不带日期后缀。**                                                                                                                                                                                                           | ARCH-API-系统分层.md                                                                 |
| 04-设计文档        | **DD-[范围]-主题**.md                                 | 前缀 DD-（Design Doc），与 PRD 主题一致；主题中含 -WEB-/-API-/-ML-/-DB-/-SYS- 范围标识。**文件名不带日期后缀。**                                                                                                                                                                              | DD-WEB-Admin页面需求.md、DD-SYS-日志功能需求.md                                      |
| 05-经验手册        | **fixbug-** 或 **经验-** + 主题**-YYYYMMDD**.md | bug 相关用 fixbug-，非 bug 用 经验-；主题中含 -WEB-/-API-/-ML-/-DB-/-SYS- 范围标识                                                                                                                                                                                                                  | fixbug-API-RSS解析异常-20260202.md、经验-SYS-Git中文提交信息乱码解决方案-20260126.md |
| 06-开发记录        | **开发记录-YYYYMMDD**.md                              | 按日期，单日单文件                                                                                                                                                                                                                                                                                  | 开发记录-20260210.md                                                                 |
| 07-运维手册        | **OPS-**主题简短描述.md                                     | 前缀 OPS-；主题中含 -WEB-/-API-/-ML-/-DB-/-SYS- 范围标识。**文件名不带日期后缀。**                                                                                                                                                                                                            | OPS-SYS-部署说明.md                                                                  |
| 08-提示词          | **提示词-YYYYMMDD**.md                                | 按日期                                                                                                                                                                                                                                                                                              | 提示词-20260210.md                                                                   |
| 09-重构记录        | **重构-**主题简短描述**-YYYYMMDD**.md           | 前缀 重构-；主题中含 -WEB-/-API-/-ML-/-DB-/-SYS- 范围标识                                                                                                                                                                                                                                           | 重构-WEB-设置页数据刷新唯一路径-20260206.md                                          |
| 10-分析报告        | **REPORT-**主题简短描述**-YYYYMMDD**.md         | 前缀 REPORT-；主题中含 -WEB-/-API-/-ML-/-DB-/-SYS- 范围标识                                                                                                                                                                                                                                         | REPORT-API-模拟器持续刷新根因分析-20260210.md                                        |
| 11-接口管理        | **API-**主题简短描述.md                                     | 前缀 API-；主题中含 -WEB-/-API-/-ML-/-DB-/-SYS- 范围标识（按接口所属）。**文件名不带日期后缀。**                                                                                                                                                                                              | API-API-request接口说明.md                                                           |

#### 约定要点

- **前缀必须带**：01 采用单文档时文件名为 我的需求.md（无 REQ 前缀）；02/03/04 用 PRD/ARCH/DD，05 用 fixbug- 或 经验-，10 用 REPORT-，11 用 API-；不得省略前缀或改用“中文-设计文档-日期”等混写。
- **主题简短描述**：与内容一致、可读即可；同一需求链上 01→02→04 的主题描述应一致（如“GUI-页面风格改为Fluent”）。**05-经验手册**：与 bug 修复、根因、防范相关的用 **fixbug-**；非 bug 类（如操作规范、最佳实践、问题解决方案、优化总结等）用 **经验-**。
- **范围标识**：主题简短描述中须按文档涉及范围加入标识：
  - **-WEB-**: 前端相关 (`apps/frontend`, UI/UX)
  - **-API-**: 后端相关 (`apps/backend`, Worker, Hono)
  - **-ML-**: 机器学习服务相关 (`services/ml`)
  - **-DB-**: 数据库/Schema 相关 (`packages/database`)
  - **-SYS-**: 系统/运维/DevOps 相关 (`ops`, `scripts`)
    若涉及多个范围，可组合使用（如 `PRD-WEB-API-xxx`）。06 开发记录、08 提示词无范围标识要求。
- **日期 YYYYMMDD**：文档创建或重大修订日期，必须为 8 位数字。
- **扩展名**：统一 .md。

#### 与 YAML doc_id 的对应关系

- 文档内 YAML 头的 `doc_id` 建议与文件名对应，如：文件 `DD-GUI-页面风格改为Fluent.md` → `doc_id: DD-GUI-页面风格改为Fluent`（与现有约定一致即可）。

#### 不符合命名规范时的处理

- Agent 在撰写 01/02/04 等文档时，若发现目标文件名未按上表格式命名，**必须按规范命名后写入**，不得沿用“主题-设计文档-日期”等旧格式。
- 已有历史文档可保留原名，但**新撰写的文档一律采用本命名规范**。

### 2.1.1 我的需求条目编号规范【强制】

**01-我的需求 中每条需求必须带唯一编号标签**，作为需求的唯一识别码。

- **格式**：`YYYYMMDD` + 3 位数字，从 `001` 起。
- **示例**：`20260211001`、`20260211002`、`20260212001`（同日多条按 001、002… 递增；跨日则可从 001 重新起）。
- **放置位置**：每条需求条目标明 `**编号**：YYYYMMDD001`（或等价写法），与状态、关联 PRD、关联 DD 并列。
- **用途**：需求追溯、PRD/设计文档引用、开发记录关联时可使用该编号唯一标识需求。

### 2.1.2 PRD 功能需求状态标注规范【强制】

**PRD 文档中“功能需求”章节的每一个功能点标题，必须在末尾标注实现状态。**

- **格式**：功能标题 + `(状态)`
- **状态枚举**：
  - `(已实现)`：功能已代码实现并验证。
  - `(待实现)`：功能尚未开始或正在排期。
  - `(进行中)`：功能正在开发中。
  - `(取消)`：功能不再开发。
- **示例**：
  - `3.1 页面布局与组织 (已实现)`
  - `3.2 交互反馈 (待实现)`

### 2.2 文档创建原则【严格执行】

**Agent 在处理新需求时，必须遵循以下优先级：**

1.  **优先更新现有文档**：根据 README 中的模块职责描述，在现有 PRD/DD 中追加新章节（例如：日志增强需求应合并至 `PRD-SYS-日志功能需求.md`，而非新建 `PRD-SYS-日志增强.md`）。
2.  **模块不匹配才新建**：仅当新需求完全超出所有现有文档的范围（如全新模块）时，才考虑新建文档。
3.  **新建需批准**：若必须新建，Agent 必须先向用户提出请求，说明原因并给出拟定文件名，获得明确批准后方可创建。
4.  **禁止随意新建**：严禁未经确认直接创建“补充需求”、“增强功能”类的独立小文档，这会导致文档碎片化。

### 2.3 02-产品需求文档 (PRD) 编写规范【强制】

**所有 02-产品需求文档 (PRD) 必须严格遵循 `docs/02-产品需求文档PRD/00-PRD-模板.md` 模板结构编写。**

请直接读取并参考该文件内容作为模板。

### 2.3 08-提示词编写规范

将对话中「用户」的提示词沉淀到 **docs/08-提示词**，便于需求回溯与复用。**仅在用户明确提出记录提示词（或等价表述，如「输出提示词」「总结对话并输出提示词」）时才执行记录与输出**，不主动写入。执行时须遵守以下约定。

- **文件名**：`提示词-YYYYMMDD.md`（与 2.1 表一致，按日期）。
- **新建与补充**：当日文件不存在则新建，已存在则在该文件末尾**补充**，不覆盖。
- **按时间顺序**：同一日内多段对话按发生顺序追加，先发生的在前。

### 2.4 DD 设计文档编写规范

**文件名**：`DD-模块-子模块简短描述.md`

**内容模板**：

**所有 04-设计文档 (DD) 必须严格遵循 `docs/04-设计文档/00-DD-模版.md` 模板结构编写（包含 YAML Header、变更记录、详细设计等）。**

**严禁使用自由格式。**

请直接读取并参考该文件内容作为模板。

### 2.5 需求记录顺序规范【强制】

**在 PRD 和 DD 文档中，涉及多个需求条目时，必须严格按照需求编号或逻辑顺序依次记录。**

- **原则**：禁止乱序记录（必须遵循 需求1 -> 需求2 -> 需求3 的顺序）。
- **格式**：
  - `## 需求1 ...`
  - `## 需求2 ...`
  - `## 需求3 ...`
- **适用范围**：02-产品需求文档PRD、04-设计文档DD。

---

- **每次补充的结构**：
  1. **总的概括**：用一段话概括本段对话的主题与结果（做了什么、要达成什么）。
  2. **我的提示词**：本段对话中用户的原话或要点，按时间顺序逐条列出（编号列表）。
- **示例结构**：`## 第 N 次补充` → `### 总的概括` → `### 我的提示词`（1. 2. 3. …）。

---

## 3. 文档元信息头（Agent Header）【强制】

**所有 docs/*.md 必须包含以下 YAML Header，否则视为“不可执行文档”**

---

```yaml
doc_type: design
doc_id: 
status: draft            # draft | review | approved | deprecated
related_prd:
  - PRD-XXX-YYYYMMDD
created: 2026-02-04
updated: 2026-02-04
```

---

### 3.1 doc_type 允许值

| doc_type     | 对应目录 |
| ------------ | -------- |
| requirement  | 01       |
| prd          | 02       |
| architecture | 03       |
| design       | 04       |
| fixbug       | 05       |
| devlog       | 06       |
| ops          | 07       |
| prompt       | 08       |
| refactor     | 09       |
| fault        | 10       |
| api          | 11       |

---

## 4. 文档状态机（Agent 必须遵守）

draft → review → approved → deprecated

### 状态语义

| 状态       | 含义   | Agent 行为                         |
| ---------- | ------ | ---------------------------------- |
| draft      | 草稿   | 允许修改，不允许引用为实现依据     |
| review     | 评审中 | 只允许评论，不允许实现             |
| approved   | 已批准 | **唯一允许作为代码实现依据** |
| deprecated | 已废弃 | 只读，禁止引用                     |

---

## 5. Agent × 目录 × 权限矩阵（最小集）

| Agent             | 可写目录 | 只读目录 | 禁止       |
| ----------------- | -------- | -------- | ---------- |
| Requirement Agent | 01 / 02  | 03+      | 直接写设计 |
| Design Agent      | 03 / 04  | 02       | 写代码     |
| Dev Agent         | 06       | 04       | 改设计     |
| Fixbug Agent      | 05 / 10  | 04       | 越权改架构 |
| Refactor Agent    | 09       | 04 / 05  | 直接改 PRD |

**规则** ：

Agent 在越权时必须拒绝执行并提示“请先补齐设计文档”。

---

## 6. 强约束策略（Policy Files）

新增目录：

docs/_policies/
├── doc-review-gate.policy.md   # 文档审核门控：从需求开始，步步审核，通过后才写下一文档
├── error-code.policy.md
├── design-first.policy.md
└── refactor.policy.md

### 示例：error-code.policy.md

---

# Error Code Policy

- error_list.csv 是错误码唯一事实源（SSOT）
- 代码中的错误码定义必须可追溯到该文件
- Agent 发现不一致时：
  1. 禁止直接改代码
  2. 输出 fixbug 设计文档
  3. 标记 status = review

---

## 7. 当前视图（Agent 自动维护）

docs/_views/
├── current-design.md
├── current-architecture.md
├── current-error-codes.md

### current-design.md 内容规则

* 仅引用 `status = approved`
* 自动排除 deprecated
* 按模块聚合

人和 AI **都只看这里**

---

## 8. 最小 Prompt 入口（给 Agent 用）

存放于：

docs/08-提示词/docs-agent.system.md

---

你是 docs-agent。

规则：

1. 只在 docs/ 下 work
2. 严格遵守文档状态机
3. 没有 approved 的设计文档 → 不允许写代码
4. 引用文档必须包含 doc_id
5. 发现冲突必须输出文档，而不是“口头建议”

---

## 9. 最小执行闭环（MVP）

### 9.1 一般需求闭环

**一个需求从 0 到落地必须经过：**

需求（01）
→ PRD（02）
→ 设计（04, approved）
→ 实现（代码）
→ 开发记录（06）
→ fixbug / 重构（05 / 09）按需
→ 更新 views

任何跳步 = **Agent 必须拒绝执行**

### 9.2 修复 Bug 闭环

**修复 bug 时，文档与落地顺序为：**

需求（01，问题描述/复现/预期）
→ PRD（02，修复目标与验收）
→ 设计（04, approved，修改计划）
→ 实现（代码修改 + linter）
→ 经验手册（05，根因/教训/防范）
→ 开发记录（06，当日记录）

- GUI 相关需求与 Bug：需求/PRD/设计/经验手册等所有文档**必须**统一存放于根目录 **docs/** 下对应目录，严禁在 `gui/` 目录下创建 `docs/`。开发记录统一记录在 **docs/06-开发记录**。
- 未走完 01 → 02 → 04 且设计未 approved，不得进入实现。

---

## 10. 文档审核门控（必须遵守）

**原则：从「我的需求」开始，每一步文档均需审核；上一文档未批准（approved），不得撰写下一阶段文档或进入实现。**

- **流程**：01 我的需求 → 审核通过 → 02 PRD → 审核通过 → 04 设计 → 审核通过 → 代码实现 → 06 开发记录等。
- **门控**：
  - 撰写 02 PRD 前：01 中已有该条需求描述（我的需求.md 第 N 条），该条状态为**待实现**（或已从「未来实现」改为待实现），且用户已指示可为该条撰写 PRD。需求审核、疑问与结论均在 **02 PRD 内**完成。撰写 PRD 后将该条状态更新为「进行中」；实现验收后改为「已完成」。
  - 撰写 04 设计前：必须有对应 02 PRD且其 `status = approved`。
  - 进行代码实现前：必须有对应 04 设计文档且其 `status = approved`。
- **审核**：文档 status 由人工或授权流程从 `draft` → `review` → `approved`。Agent 不得自行将文档标为 `approved`，除非用户明确指令「批准」/「通过」/「approved」。
- **详细策略**：见 **docs/_policies/doc-review-gate.policy.md**。任何跳步 = Agent 必须拒绝执行并提示「请先完成上一阶段文档并审核通过」。

### 10.1 模块化 PRD 与增量更新策略

为支持大型或持续迭代项目，02-产品需求文档PRD 允许模块化和增量更新。

- **模块化 PRD**：
  - 一个大的产品需求可以拆分为多个独立的 PRD 文档，每个文档聚焦于一个具体的功能模块或子系统。
  - 每个模块化 PRD 仍需遵循 2.1 节的命名规范，并包含独立的 YAML Header。
  - `related_prd` 字段可用于关联主 PRD 或其他相关模块 PRD。
- **增量更新**：
  - 对于已存在的 `status = approved` 的 PRD 文档，允许进行增量更新，而非必须新建一个 PRD。
  - **增量更新流程**：
    1. Agent 收到更新指令后，将原 PRD 的 `status` 从 `approved` 改为 `review`。
    2. Agent 在原 PRD 文档中追加更新内容，并清晰标记更新日期和内容（例如，使用二级标题 `## 增量更新 - YYYYMMDD`）。
    3. 更新完成后，Agent 需将 `updated` 字段更新为当前日期。
    4. 更新后的 PRD 需重新走 `review` → `approved` 流程。
  - **Agent 行为**：
    - 当用户指示对已批准的 PRD 进行修改时，Agent 必须将该 PRD 的状态置为 `review`，并记录更新内容。
    - Agent 不得直接修改已批准 PRD 的核心内容而不改变其状态。
    - 对于重大变更，Agent 应建议新建 PRD 或在现有 PRD 中明确标记为新版本。

### 10.2 需求/设计疑问提出规范（Agent 必须遵守）

在 01-我的需求、02 PRD、04 设计 等文档中，Agent 提出「需求审核疑问」「阶段疑问」或任何需需求方/评审方回答的**封闭式或选型类问题**时，**必须同时**：

1. **推荐方案**：明确写出推荐的选项或结论（如「推荐方案 A」「推荐：是」），便于需求方快速决策。
2. **优劣说明**：对推荐方案及主要备选做简要优劣对比（一两句即可），说明推荐理由或备选代价。

需求方在回答时既可采纳推荐，也可在了解优劣后选择其他方案；且便于后续 PRD/设计定稿与实现一致。非选型类、纯事实确认类问题可仅给出推荐结论，不强制优劣对比。

---

Version: docs-agents v1
Status: frozen
Change Policy: only via new version (v2, v3…)

---
